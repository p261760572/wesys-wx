<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>商户信息</title>
    <link rel="stylesheet" href="../js/lib/weuijs/style/weuijs.min.css">
    <link rel="stylesheet" href="../css/ui-base.css">
</head>

<body>
    <div class="page page_show">
        <form id="form">
            <div class="weui-cells__title">营业执照</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">营业执照正面照片</p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="01">
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户名称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_name" required="" placeholder="请输入商户名称">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">营业执照号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="license_no" required="" placeholder="请输入营业执照号" validType="license_no" invalidTips="请输入有效的营业执照" onkeyup="this.value=this.value.toUpperCase()">
                    </div>
                </div>
            </div>
            <div class="weui-cells__title">企业法人/证件持有人</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">证件类型<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select" name="cert_type" required missingTips="请选择证件类型">
                            <option value="01">身份证</option>
                        </select>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">身份证正面照片<span class="required">*</span></p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="03">
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">身份证反面照片</p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="99">
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件姓名<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="cert_name" required="" placeholder="请输入证件姓名">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件号码<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="cert_id" required="" placeholder="请输入证件号码" validType="idnum" invalidTips="请输入有效的证件号码">
                    </div>
                </div>
            </div>
            <div class="weui-btn-area btn-area">
                <a id="back-btn" href="javascript:" class="weui-btn weui-btn_default" onclick="weui.page.back()">返回</a>
                <a id="submit-btn" href="javascript:" class="weui-btn weui-btn_primary">提交</a>
            </div>
        </form>
    </div>
    <!-- <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=mUs8UNiHRImGLNueae1Gd9PVdejrYdHC"></script> -->
    <script type="text/javascript" src="../js/lib/zepto.min.js"></script>
    <script type="text/javascript" src="../js/lib/weuijs/weuijs.min.js"></script>
    <script>
    var query = $$.parseQueryString();
    var operateType = query.operateType;

    var uploaderData = [];

    function initUploader(selector, options) {
        options = options || {};
        options = $.extend({
            url: $$.wrapUrl('/action/upload'),
            auto: true,
            type: 'file',
            fileVal: 'file',
            compress: {
                width: 1600,
                height: 1600,
                quality: 0.92
            },
            onBeforeSend: function(data, headers) {
                console.log(this, arguments);
                if (["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0) {
                    weui.alert('请上传图片');
                    return false; // 阻止文件添加
                }
                if (this.size > max_size * 1024 * 1024) {
                    weui.alert('请上传不超过10M的图片');
                    return false;
                }
                // return false; // 阻止文件上传
            },
            onSuccess: function(ret) {
                console.log(this, ret);;
            },
            onError: function(err) {
                console.log(this, err);
            }
        }, options);
        return weui.ajaxUploader(selector, options);
    }

    $('.weui-uploader').each(function(i, element) {
        initUploader(this, {
            onSuccess: function(ret) {
                console.log(ret);
                var elec_info_type = $(this).find('.weui-uploader__files').attr('id');
                uploaderData.push({
                    status: '1',
                    serverid: ret.serverid,
                    elec_info_type: elec_info_type
                });
            },
        });
    });

    function onSubmit() {
        if (!weui.form.validate('#form', $$.rules)) return;
        var param = $('#form').serializeObject();
        var elec_info = [];

        $('#form').find('.weui-uploader__file').forEach(function(item) {
            var id = parseInt($(item).attr('data-id'));
            elec_info.push(uploaderData[id]);
        });

        param.elec_info = elec_info;        
        param.mchnt_id = query.mchnt_id;

        $$.request('/action/bm/mchnt-base-busi/update-base', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    var flow = flows.busi(query.busi_type, query.acq_inst_id);
                    flow.next({
                        mchnt_param_id: data.mchnt_param_id
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            }
        });
    }

    $(function() {
        $('#submit-btn').on('click', onSubmit);
    });
    </script>
</body>

</html>
