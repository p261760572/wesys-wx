<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>商户基本信息</title>
    <link rel="stylesheet" href="../js/lib/weuijs/style/weuijs.css">
    <link rel="stylesheet" href="../css/ui-base.css">
    <style type="text/css">
    </style>
</head>

<body>
    <div id="search-page" class="page page_show">
        <div class="weui-search-bar">
            <a id="add-btn" href="javascript:" class="search-bar__btn">新增</a>
            <form class="weui-search-bar__form" method="post" action="">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" name="search" placeholder="支持联系人、商户简称、地址">
                    <a href="javascript:" class="weui-icon-clear"></a>
                </div>
                <label class="weui-search-bar__label">
                    <i class="weui-icon-search"></i>
                    <span>搜索商户</span> </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn">取消</a>
        </div>
        <div class="weui-cells searchbar-result">
        </div>
    </div>
    <div id="detail-page" class="page">
        <form id="form">
            <input type="hidden" name="rec_id">
            <input type="hidden" name="oper_in">
            <input type="hidden" name="proc_st">
            <div class="weui-cells__title">商户基本信息</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">客户号</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_id" placeholder="请输入客户号">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系人<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="linkman" required="" pattern="" placeholder="请输入联系人">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">手机号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mobile" required="" placeholder="请输入手机号" validType="mobile" invalidTips="请输入有效的手机号">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">常用邮箱</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="email" placeholder="请输入常用邮箱" validType="email" invalidTips="请输入有效的邮箱">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户简称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_abbr" required="" placeholder="请输入商户简称">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系电话</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="telno" placeholder="请输入联系电话" validType="telno" invalidTips="请输入有效的电话号码">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">所在地区<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="district_name" required="" placeholder="请选择所在地区" id="city-picker">
                        <input type="hidden" name="province">
                        <input type="hidden" name="city">
                        <input type="hidden" name="district">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">详细地址<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="addr" required="" placeholder="请输入详细地址" id="addr">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户名称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_name" required="" placeholder="请输入商户名称">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">营业执照号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="license_no" required="" placeholder="请输入营业执照号" validType="license_no" invalidTips="请输入有效的营业执照">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">营业执照期限</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="license_date" placeholder="请选择营业执照期限" validType="date" id="license-date-picker">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">注册地址</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="license_addr" placeholder="请输入注册地址">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">经营范围</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="business_scope" placeholder="请输入经营范围">
                    </div>
                </div>
                <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">证件类型<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select" name="cert_type" required missingTips="请选择证件类型">
                            <option value="01">身份证</option>
                        </select>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件姓名<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="cert_name" required="" placeholder="请输入证件姓名">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件号码<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="cert_id" required="" placeholder="请输入证件号码" validType="idnum" invalidTips="请输入有效的证件号码">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件有效期</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="cert_date" placeholder="请输入证件有效期" validType="date" id="cert-date-picker">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">组织机构代码</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="org_code" placeholder="请输入组织机构代码" pattern="^[A-Za-z0-9]+$" invalidTips="请输入有效的组织机构代码">
                    </div>
                </div>
                <!-- <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">状态<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select" name="status">
                            <option value="1">正常</option>
                            <option value="0">注销</option>
                        </select>
                    </div>
                </div> -->
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">备注</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="remark" placeholder="请输入备注">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">拓展方<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="expand_inst_nm" required="" placeholder="请选择拓展方" id="expand-inst-select2">
                        <input type="hidden" name="expand_inst_id">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">拓展人<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="expand_nm" required="" placeholder="请选择拓展人" id="expand-select2">
                        <input type="hidden" name="expand_id">
                    </div>
                </div>
            </div>
            <div class="weui-btn-area btn-area">
                <a id="back-btn" href="javascript:" class="weui-btn weui-btn_default" onclick="weui.page.back()">返回</a>
                <a id="submit-btn" href="javascript:" class="weui-btn weui-btn_primary">提交</a>
            </div>
        </form>
    </div>
    <div id="preview-page" class="page">
        <div class="weui-form-preview">
            <div class="weui-form-preview__hd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">商户基本信息</label>
                </div>
            </div>
            <div class="weui-form-preview__bd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">客户号</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_id"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">联系人</label>
                    <span class="weui-form-preview__value" id="preview-linkman"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">手机</label>
                    <span class="weui-form-preview__value" id="preview-mobile"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">常用邮箱</label>
                    <span class="weui-form-preview__value" id="preview-email"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">商户简称</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_abbr"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">联系电话</label>
                    <span class="weui-form-preview__value" id="preview-telno"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">所在地区</label>
                    <span class="weui-form-preview__value" id="preview-district_name"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">详细地址</label>
                    <span class="weui-form-preview__value" id="preview-addr"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">商户名称</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_name"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">营业执照号</label>
                    <span class="weui-form-preview__value" id="preview-license_no"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">营业执照期限</label>
                    <span class="weui-form-preview__value" id="preview-license_date"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">注册地址</label>
                    <span class="weui-form-preview__value" id="preview-license_addr"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">经营范围</label>
                    <span class="weui-form-preview__value" id="preview-business_scope"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">证件类型</label>
                    <span class="weui-form-preview__value" id="preview-cert_type_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">证件姓名</label>
                    <span class="weui-form-preview__value" id="preview-cert_name"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">证件号码</label>
                    <span class="weui-form-preview__value" id="preview-cert_id"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">证件有效期</label>
                    <span class="weui-form-preview__value" id="preview-cert_date"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">组织机构代码</label>
                    <span class="weui-form-preview__value" id="preview-org_code"></span>
                </div>
                <!-- <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">状态</label>
                    <span class="weui-form-preview__value" id="preview-status_nm"></span>
                </div> -->
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">备注</label>
                    <span class="weui-form-preview__value" id="preview-remark"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">拓展方</label>
                    <span class="weui-form-preview__value" id="preview-expand_inst_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">拓展人</label>
                    <span class="weui-form-preview__value" id="preview-expand_nm"></span>
                </div>
            </div>
            <div class="weui-form-preview__ft">
                <a class="weui-form-preview__btn weui-form-preview__btn_default" href="javascript:" onclick="weui.page.back()">返回</a>
                <!-- <button type="submit" class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:">编辑</button> -->
            </div>
        </div>
    </div>
    <script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=mUs8UNiHRImGLNueae1Gd9PVdejrYdHC"></script>
    <script type="text/javascript" src="../js/lib/zepto.js"></script>
    <script type="text/javascript" src="../js/lib/weuijs/weuijs.js"></script>
    <script type="text/javascript" src="../js/district.js"></script>
    <script type="text/javascript" src="../js/param.js"></script>
    <script id="result-template" type="text/html">
        {{each rows as row i}}
        <a class="weui-cell weui-cell_access searchbar-result__item" href="javascript:;" data-index="{{total+i}}">
            <div class="weui-cell__bd weui-cell_primary">
                <p>{{row.mchnt_abbr}}</p>
            </div>
            <div class="weui-cell__ft" style="color:#f6383a;">{{row.proc_st_nm}}</div>
        </a>
        <div class="weui-media-box weui-media-box_text">
            <div class="weui-media-box__desc">联系人：{{row.linkman}}</div>
            <div class="weui-media-box__desc">联系人手机：{{row.mobile}}</div>
            <div class="weui-media-box__desc">地址：{{row.addr}}</div>
            <div class="weui-media-box__desc">商户名称：{{row.mchnt_name}}</div>
            <div class="weui-media-box__desc">营业执照：{{row.license_no}}</div>
            <div class="weui-media-box__desc">审核备注：{{row.checked_reason}}</div>
            <ul class="weui-media-box__info">
                <li class="weui-media-box__info__meta">创建时间：{{row.created_time}}</li>
				<li class="weui-media-box__info__meta weui-media-box__info__meta_extra">创建人：{{row.last_created_by_nm}}</li>
            </ul>
            <ul class="weui-media-box__info" style="margin-top: 0px;">
                <li class="weui-media-box__info__meta">修改时间：{{row.last_modified_time}}</li>
				<li class="weui-media-box__info__meta weui-media-box__info__meta_extra">修改人：{{row.last_modified_by_nm}}</li>
            </ul>
            <ul class="weui-media-box__info" style="margin-top: 0px;">
                <li class="weui-media-box__info__meta">审核时间：{{row.last_checked_time}}</li>
                <li class="weui-media-box__info__meta weui-media-box__info__meta_extra">审核人：{{row.last_checked_by_nm}}</li>
            </ul>
        </div>
        {{/each}}
    </script>
    <script>
    var operateType;
    var searchPage = weui.searchPage('#search-page', {
        resultTpl: '#result-template',
        loader: onSearch,
        onInput: function() {
            console.log(this, arguments);
        },
        onClickItem: function(row) {
            console.log(this, arguments);
            // weui.page.back();
            showActions(row);
        }
    }).search();

    function onSearch(param, success, error) {
        $$.request('/action/bm/mchnt-base-info/search', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    success(data.rows);
                } else if(data.errcode == 5) {
                    window.location.href = $$.wrapUrl('/m/login.html');
                } else {
                    weui.alert(data.errmsg, error, {
                        title: '提示'
                    });
                }
            },
            error: function() {
                error();
            }
        });
    }

    function onPreview(param) {
        weui.page.show('#preview-page');

        $$.request('/action/bm/mchnt-base-info/view', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    data.data.cert_type_nm = $$.formatField($$.param['cert_type'], data.data.cert_type);
                    for (var name in data.data) {
                        $('#preview-' + name).html(data.data[name]);
                    }
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onView(param) {
        weui.page.show('#detail-page');

        $$.request('/action/bm/mchnt-base-info/view', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.form.load('#form', data.data);
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onDelete(param) {
        $$.request('/action/bm/mchnt-base-info/delete', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        searchPage.search();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function showActions(row) {
        var actions = [{
            label: '查看',
            onClick: function() {
                console.log(this, arguments);
                onPreview(row);
                $('#back-btn').show().siblings().hide();
            }
        }]

        if ($.inArray(row.proc_st, ['8', '9', 'A']) >= 0) {
            actions.push({
                label: '编辑',
                onClick: function() {
                    console.log(this, arguments);
                    operateType = 'update';
                    onView(row);
                    $('#back-btn').show().siblings().show();
                }
            });
        }

        if (row.oper_in == 'I' && $.inArray(row.proc_st, ['9', 'A']) >= 0) {
            actions.push({
                label: '删除',
                onClick: function() {
                    console.log(this, arguments);
                    weui.confirm('确认要删除?', function() {
                        onDelete(row);
                    });
                }
            });
        }

        actions.push({
            label: '商户参数',
            onClick: function() {
                console.log(this, arguments);
                window.location.href = 'mchnt-param.html?' + $.param({
                    mchnt_id: row.mchnt_id
                });
            }
        });

        actions.push({
            label: '终端管理',
            onClick: function() {
                console.log(this, arguments);
                window.location.href = 'term-info.html?' + $.param({
                    mchnt_id: row.mchnt_id
                });
            }
        });

        actions.push({
            label: '电子资料',
            onClick: function() {
                console.log(this, arguments);
                window.location.href = 'mchnt-elec-info.html?' + $.param({
                    mchnt_id: row.mchnt_id
                });
            }
        });

        weui.actionSheet(actions, [{
            label: '取消',
            onClick: function() {
                console.log(this, arguments);
            }
        }]);
    }

    // 失去焦点时检测
    weui.form.checkIfBlur('#form', $$.rules);

    function onSubmit() {
        if (!weui.form.validate('#form', $$.rules)) return;
        var param = $('#form').serializeObject();

        $$.request('/action/bm/mchnt-base-info/' + operateType, param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        searchPage.search();
                        weui.page.back();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onClickAdd() {
        operateType = 'create';
        weui.page.show('#detail-page');
        weui.form.clear('#form');
        //默认值
        weui.form.load('#form', {
            cert_type: '01',
            status: '1'
        });
        $('#back-btn').show().siblings().show();

        getLocation(function (addr) {
            setPickerValues('#city-picker', districtData, [addr.province,addr.city,addr.district]);
            $('#addr').val(addr.street+addr.streetNumber);
        });
    }

    function setPickerValues(target, items, arr) {
        var result = [];
        
        function getValue(items, depth) {
            for (var i = 0; i < items.length; i++) {
                if(items[i].text == arr[depth]) {
                    result[depth] = items[i].value;
                    if(items[i].children && items[i].children.length) {
                        getValue(items[i].children, depth+1);   
                    }
                    break;
                }
            }
        }

        getValue(items, 0);

        var $target = $(target);
        var $temp = $target;
        for (var i = 0; i < result.length; i++) {
            $temp = $temp.next();
            $temp.val(result[i]);
        }
        $target.val(arr.join(' ')).change(); //触发change

        return result;
    }

    function getLocation(success) {
        var geolocation = new BMap.Geolocation();
        geolocation.getCurrentPosition(function(r) {
            if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                
                var geoc = new BMap.Geocoder();
                var pt = r.point;

                geoc.getLocation(pt, function(rs) {
                    console.log(this, arguments);
                    // var addComp = rs.addressComponents;
                    // alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
                    if(success) success(rs.addressComponents);
                });
            } else {
                console.log(this, arguments);
            }
        }, {
            enableHighAccuracy: true
        });
    }

    $(function() {
        $('#add-btn').on('click', onClickAdd);
        $('#submit-btn').on('click', onSubmit);

        //init component
        $('#city-picker').on('focus', function() {
            $$.showPicker(this, districtData);
        });

        $('#license-date-picker').on('focus', function() {
            $$.showDatePicker(this);
        });

        $('#cert-date-picker').on('focus', function() {
            $$.showDatePicker(this);
        });

        $('#expand-inst-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索拓展方',
                url: '/action/bm/expand-inst/search'
            }).search();
        });

        $('#expand-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索拓展人',
                url: '/action/bm/expand/search'
            }).search();
        });
    });
    </script>
</body>

</html>
