<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>e通</title>
    <link rel="stylesheet" href="../js/lib/weuijs/style/weuijs.css">
    <link rel="stylesheet" href="../css/ui-base.css">
    <style type="text/css">
    .show-more {
        display: none;
    }
    
    .page_more .show-more {
        display: block;
    }
    
    .page_more .hide-more {
        display: none;
    }
    
    .page_view .hide-view {
        display: none;
    }
    </style>
</head>

<body>
   	<div id="page1" class="page page_show">
        <div class="weui-search-bar">
            <a id="add-btn" href="javascript:" class="search-bar__btn">新增</a>
            <form class="weui-search-bar__form" method="post" action="">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" name="search" placeholder="搜索">
                    <a href="javascript:" class="weui-icon-clear"></a>
                </div>
                <label class="weui-search-bar__label">
                    <i class="weui-icon-search"></i>
                    <span>搜索</span> </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn">取消</a>
        </div>
        <div class="weui-cells searchbar-result"></div>
    </div>
    <div id="page2" class="page">
        <form id="form">
            <div class="weui-cells__title">商户基本信息</div>
            <div class="weui-cells weui-cells_form">
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">联系人<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                                <input name="linkman" type="text" class="weui-input validate" placeholder="请输入联系人" required title="联系人">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">联系人手机<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="mobile" type="text" class="weui-input validate" placeholder="请输入联系人手机" required title="联系人手机">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">联系电话</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="tel_no" type="text" class="weui-input" placeholder="请输入联系电话">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">营业执照号码<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input id="license_no" name="license_no" type="text" class="weui-input validate" placeholder="请输入营业执照号码" required title="营业执照号码" style="text-transform:uppercase;">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">户名<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input id="account_name" name="account_name" type="text" class="weui-input validate" placeholder="请输入户名" required title="户名">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">账号<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input id="account_no" name="account_no" type="text" class="weui-input validate" placeholder="请输入账号" required title="账号">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">开户支行名称<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input id="subbranch_name" name="subbranch_name" type="text" class="weui-input validate" placeholder="请选择开户支行名称" required title="开户支行名称" readonly>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">借记卡手续费<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="fee_algo" type="text" class="weui-input validate" placeholder="请选择借记卡手续费" id="fee_algo" required title="借记卡手续费" readonly>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">贷记卡手续费<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="credit_fee_algo" type="text" class="weui-input validate" placeholder="请选择贷记卡手续费" id="credit_fee_algo" required title="贷记卡手续费" readonly>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">装机地区<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input id="district" name="district_name" type="text" class="weui-input validate" placeholder="请选择装机地区" required title="装机地区" readonly>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">装机详细地址<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="installed_addr" type="text" id="installed_addr" class="weui-input validate" placeholder="请输入详细地址(需核对)" required title="装机详细地址">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label for="" class="weui-label">机具类型<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <!-- <select id="equi_type" class="weui-select validate" name="equi_type" required="required" title="机具类型">
                            </select> -->
                            <input name="equi_type" type="text" class="weui-input validate" placeholder="请选择机具类型" id="equi_type" required>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">装机数量<span class="required">*</span></label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="num_term" type="number" class="weui-input validate" placeholder="请输入装机数量" value="1" required title="装机数量">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">押金</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="deposit_amount" type="number" class="weui-input" placeholder="请输入押金">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">通讯费</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="traffic_amount" type="number" class="weui-input" placeholder="请输入通讯费">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">销售款</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="sale_amount" type="number" class="weui-input" placeholder="请输入销售款">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">备注</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input name="remark" type="text" class="weui-input" placeholder="请输入备注">
                        </div>
                    </div>
                </div>
                <div class="weui-cells weui-cells_form" >
                    <div class="weui-cells__title">上传照片</div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    营业执照照片<span class="required">*</span>
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="01">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    法人身份证照片
                                    <span class="required">*</span>
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="03">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    结算账户(银行卡)照片
                                    <span class="required">*</span>
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="16">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell show-more">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd ">
                                    税务登记证照片
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="02">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell show-more">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    商户协议(v1)
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="06">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell show-more">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    门店照片
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="04">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell show-more">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    账号授权书
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="13">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="weui-cells weui-cells_form" >
                    <div class="weui-cell show-more">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    其他照片
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="17">
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" value="照片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="javascript:;" class="weui-cell weui-cell_link" onclick="showMore()">
                    <div class="weui-cell__bd" style="text-align: center;"><span class="hide-more">更多</span><span class="show-more">隐藏</span></div>
                </a>
                <input type="button" class="weui-btn weui-btn_primary hide-view" value="提交" onclick="submitDetail()">
            </form>
        </div>
    <script type="text/javascript" src="../js/lib/zepto.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/lib/weuijs/weuijs.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://api.map.baidu.com/api?ak=kKuGiC4LbGgwrcfd1pQKq7M5Ax2GAnCy&v=2.0&s=1"></script>
    <script id="result-template" type="text/html">
        {{each rows as row}}
        <div class="weui-cell weui-cell_access searchbar-result__item">
            <div class="weui-cell__bd weui-cell_primary">
                <p>
                    {{row.text}}
                </p>
            </div>
            <div class="weui-cell__ft">
            </div>
        </div>
        {{/each}}
    </script>
    
    <script>
		var operateType;
		var searchPage = weui.searchPage('#page1', {
			resultTpl: '#result-template',
			loader: onSearch,
			onChange: function() {
				console.log(this, arguments);
			},
			onSelect: function(row) {
				console.log(this, arguments);
				// weui.page.back();
				showActions(row);
			}
		});

		function onSearch(param, success, error) {
			$$.request('/action/bm/mchnt-base-info/search', param, {
				success: function(data) {
					if (data.errcode == 0) {
						success(data.rows);
					} else {
						weui.alert(data.errmsg, function () {
							error();
						}, { title: '提示' });
					}
				},
				error: function() {
					error();
				}
			});
		}
		
		function onView(param) {
			$$.request('/action/bm/mchnt-base-info/view', param, {
				success: function(data) {
					if (data.errcode == 0) {
						weui.form.load('#form', data.data);
					} else {
						weui.alert(data.errmsg, { title: '提示' });
					}
				},
				error: function() {}
			});
		}

		function onDelete(param) {
			$$.request('/action/bm/mchnt-base-info/delete', param, {
				success: function(data) {
					if (data.errcode == 0) {
						weui.toast('操作成功');
					} else {
						weui.alert(data.errmsg, { title: '提示' });
					}
				},
				error: function() {}
			});
		}

		function showActions(row) {
			weui.actionSheet([{
				label: '查看',
				onClick: function() {
					console.log(this, arguments);
					onView(row);
					weui.page.show('#page2');
					$('#back-btn').show().siblings().hide();
				}
			}, {
				label: '新增',
				onClick: function() {
					console.log(this, arguments);
					onView(row);
					operateType = 'create';
					weui.page.show('#page2');
					$('#back-btn').show().siblings().show();
				}
			}, {
				label: '编辑',
				onClick: function() {
					console.log(this, arguments);
					onView(row);
					operateType = 'update';
					weui.page.show('#page2');
					$('#back-btn').show().siblings().show();
				}
			}, {
				label: '删除',
				onClick: function() {
					console.log(this, arguments);
					weui.confirm('确认要删除?', function() {
						onDelete(row);
					});
				}
			}], [{
				label: '取消',
				onClick: function() {
					console.log(this, arguments);
				}
			}]);
		}
		
		function onSubmit() {
			if (!weui.form.validate('#form', options)) return;
			var param = serializeDetailForm();

			$$.request('/action/bm/mchnt-base-info/' + operateType, param, {
				success: function(data) {
					if (data.errcode == 0) {
						weui.toast('操作成功');
					} else {
						weui.alert(data.errmsg, { title: '提示' });
					}
				},
				error: function() {}
			});
		}

		function onClickAdd() {
			operateType = 'create';
			weui.page.show('#page2');
		}
		
		function showMore() {
			var page = $('#page2');
			if (page.hasClass('page_more')) {
				page.removeClass('page_more');
			} else {
				page.addClass('page_more');
			}
		}
		
		function serializeDetailForm() {
			var data = $('#form').serializeObject();
			data.apptype = '105';
			data.license_no = data.license_no.toUpperCase();

			//照片处理
			var images = [];
			$('#form').find('.weui-uploader__files').each(function(i, element) {
				var type = $(element).attr('id');
				var container = $(element).children('.weui-uploader__file').each(function(i, element) {
					var fileData = $(element).data('file');
					images.push($.extend(fileData, {
						'ei_type': type
					}));
				});
			});

			data.images = images;

			return data;
		}


		function loadDetailForm(data) {
			//图片
			$('#detail-fm').find('.weui-uploader__files').each(function(i, element) {
				$(element).html('');
			});

			var images = data.images;
			$.each(images, function(index, item) {
				var file = $(template('uploader-file-templ', item)).data('file', item);
				$('#' + item.ei_type).append(file);
			});

			$('#detail-fm').form('load', data.data);
		}

		function hasImage(images, ei_type) {
			for (var i = 0; i < images.length; i++) {
				if (images[i].ei_type == ei_type) {
					return true;
				}
			}
			return false;
		}


		function saveDetail() {
			var data = serializeDetailForm();
			var images = data.images;
			delete data.images;

			$$.setData('detail', {
				data: data,
				images: images
			});
			$.toast('show', '暂存成功');
		}
		
		$(function(){
			$('#add-btn').on('click', onClickAdd);
        	$('#submit-btn').on('click', onSubmit) ;
			$$.request('/action/ms/parameter/list', {
				debit_fee_algo: '1',
				credit_fee_algo: '1',
				equi_type: '1',
				account_bank: '1'
			}, function(data) {
				if (data.errcode == 0) {
					$("#equi_type").select({
						title: '请选择机具类型',
						items: data.equi_type
					});

					$("#district").select({
						title: '请选择装机地区',
						items: district
					});

					$("#fee_algo").select({
						title: '请选择借记卡手续费',
						items: data.debit_fee_algo
					});

					$("#credit_fee_algo").select({
						title: '请选择贷记卡手续费',
						items: data.credit_fee_algo
					});
				}
			});
			
			$('#subbranch_name').on('click', function() {
				var select2 = weui.select2({
					data: [],
					loader: function(param, success, error) {
						 $.ajax({
						     url: 'url',
						     type: 'POST',
						     dataType: 'json',
						     data: param,
						     success: function(data) {
						         success(data.rows);
						     },
						     error: function(error) {
						         error();
						     }
						 });
					},
					onClickItem: function(row) {
						console.log(arguments);
						$('#subbranch_name').val(row.text);
					}
				});
    		});
			
			$('.weui-uploader').each(function(i, element) {
				var uploadCount = 0;
				var uploader = weui.ajaxUploader(this, {
					url: '/m/action/upload',
					auto: true,
					type: 'file',
					fileVal: 'file',
					compress: {
						width: 1600,
						height: 1600,
						quality: 0.92
					},
					onBeforeSend: function(data, headers) {
						console.log(this, arguments);
						// $.extend(data, { test: 1 }); // 可以扩展此对象来控制上传参数
						// $.extend(headers, { Origin: 'http://127.0.0.1' }); // 可以扩展此对象来控制上传头部
						if(["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0){
							weui.alert('请上传图片');
							return false; // 阻止文件添加
						}
						if(this.size > 10 * 1024 * 1024){
							weui.alert('请上传不超过10M的图片');
							return false;
						}
						if (files.length > 1) { // 防止一下子选择过多文件
							weui.alert('最多同时传1张图片，请重新选择');
							return false;
						}
						// return false; // 阻止文件上传
					},
					onProgress: function(procent) {
						console.log(this, arguments);
						// return true; // 阻止默认行为，不使用默认的进度显示
					},
					onSuccess: function(ret) {
						console.log(this, arguments);
						// return true; // 阻止默认行为，不使用默认的成功态
					},
					onError: function(err) {
						console.log(this, arguments);
						// return true; // 阻止默认行为，不使用默认的失败态
					}
				});
			});
		})
	</script>
</body>

</html>
