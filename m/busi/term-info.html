<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>终端信息</title>
    <link rel="stylesheet" href="../js/lib/weuijs/style/weuijs.css">
    <link rel="stylesheet" href="../css/ui-base.css">
    <style type="text/css">
    </style>
</head>

<body>
    <div id="search-page" class="page page_show">
        <div class="weui-search-bar">
            <a id="add-btn" href="javascript:" class="search-bar__btn hide">新增</a>
            <form class="weui-search-bar__form" method="post" action="">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" name="search" placeholder="支持联系人、门店名称、地址">
                    <a href="javascript:" class="weui-icon-clear"></a>
                </div>
                <label class="weui-search-bar__label">
                    <i class="weui-icon-search"></i>
                    <span>搜索终端信息</span> </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn">取消</a>
        </div>
        <div class="weui-cells searchbar-result">
        </div>
    </div>
    <div id="detail-page" class="page">
        <form id="form">
            <input type="hidden" name="rec_id">
            <input type="hidden" name="oper_in">
            <input type="hidden" name="proc_st">
            <div class="weui-cells__title">终端信息</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">终端标识</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="term_no" placeholder="请输入终端标识" readonly>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">客户号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_id" required="" placeholder="请输入客户号" readonly>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系人<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="linkman" required="" placeholder="请输入联系人">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">手机号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mobile" required="" placeholder="请输入手机号" validType="mobile" invalidTips="请输入有效的手机号">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">门店名称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="shop_name" required="" placeholder="请输入门店名称">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系电话</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="telno" placeholder="请输入联系电话" validType="telno" invalidTips="请输入有效的电话号码">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">所在地区<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="district_name" required="" placeholder="请选择所在地区" id="city-picker">
                        <input type="hidden" name="province">
                        <input type="hidden" name="city">
                        <input type="hidden" name="district">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">详细地址<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="addr" required="" placeholder="请输入详细地址" id="addr">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">终端投资方<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="term_inves_nm" required="" placeholder="请选择终端投资方" id="term-inves-select2">
                        <input type="hidden" name="term_inves">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">机具类型<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="equi_type_nm" required="" placeholder="请选择机具类型" id="equi-type-select2">
                        <input type="hidden" name="equi_type">
                    </div>
                </div>
                <div class="weui-cell" id="term_num" type="hidden">
                    <div class="weui-cell__hd">
                        <label class="weui-label">终端数量</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" placeholder="请输入终端数量" type="number" name="term_num">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">装机日期</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="installed_date" placeholder="请输入装机日期">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">撤机日期</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="removed_date" placeholder="请输入撤机日期">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">装机人</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="installed_by" placeholder="请输入装机人">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">维护人</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="maintained_by" placeholder="请输入维护人">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">终端状态</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="term_status" required="" placeholder="请输入终端状态">
                    </div>
                </div>
                <!--div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">拓展方<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="expand_inst_nm" required="" placeholder="请输入拓展方" id="expand-inst-select2">
                        <input type="hidden" name="expand_inst_id">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">拓展人<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="expand_nm" required="" placeholder="请输入拓展人" id="expand-select2">
                        <input type="hidden" name="expand_id">
                    </div>
                </div-->
            </div>
            <div class="weui-btn-area btn-area">
                <a id="back-btn" href="javascript:" class="weui-btn weui-btn_default" onclick="weui.page.back()">返回</a>
                <a id="submit-btn" href="javascript:" class="weui-btn weui-btn_primary">提交</a>
            </div>
        </form>
    </div>
    <div id="preview-page" class="page">
        <div class="weui-form-preview">
            <div class="weui-form-preview__hd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">终端信息</label>
                </div>
            </div>
            <div class="weui-form-preview__bd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">终端标识</label>
                    <span class="weui-form-preview__value" id="preview-term_no"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">客户号</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_id"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">联系人</label>
                    <span class="weui-form-preview__value" id="preview-linkman"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">手机号</label>
                    <span class="weui-form-preview__value" id="preview-mobile"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">门店名称</label>
                    <span class="weui-form-preview__value" id="preview-shop_name"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">联系电话</label>
                    <span class="weui-form-preview__value" id="preview-telno"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">所在地区</label>
                    <span class="weui-form-preview__value" id="preview-district_name"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">详细地址</label>
                    <span class="weui-form-preview__value" id="preview-addr"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">终端投资方</label>
                    <span class="weui-form-preview__value" id="preview-term_inves_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">机具类型</label>
                    <span class="weui-form-preview__value" id="preview-equi_type_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">装机日期</label>
                    <span class="weui-form-preview__value" id="preview-installed_date"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">撤机日期</label>
                    <span class="weui-form-preview__value" id="preview-removed_date"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">装机人</label>
                    <span class="weui-form-preview__value" id="preview-installed_by_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">维护人</label>
                    <span class="weui-form-preview__value" id="preview-maintained_by_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">终端状态</label>
                    <span class="weui-form-preview__value" id="preview-term_status_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">拓展方</label>
                    <span class="weui-form-preview__value" id="preview-expand_inst_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">拓展人</label>
                    <span class="weui-form-preview__value" id="preview-expand_nm"></span>
                </div>
            </div>
            <div class="weui-form-preview__ft">
                <a class="weui-form-preview__btn weui-form-preview__btn_default" href="javascript:" onclick="weui.page.back()">返回</a>
                <!-- <button type="submit" class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:">编辑</button> -->
            </div>
        </div>
    </div>
    <script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=mUs8UNiHRImGLNueae1Gd9PVdejrYdHC"></script>
    <script type="text/javascript" src="../js/lib/zepto.js"></script>
    <script type="text/javascript" src="../js/lib/weuijs/weuijs.js"></script>
    <script type="text/javascript" src="../js/district.js"></script>
    <script type="text/javascript" src="../js/param.js"></script>
    <script id="result-template" type="text/html">
        {{each rows as row i}}
        <a class="weui-cell weui-cell_access searchbar-result__item" href="javascript:;" data-index="{{total+i}}">
            <div class="weui-cell__bd weui-cell_primary">
                <p>{{row.shop_name}}</p>
            </div>
            <div class="weui-cell__ft" style="color:#f6383a;">{{row.proc_st_nm}}</div>
        </a>
        <div class="weui-media-box weui-media-box_text">
            <div class="weui-media-box__desc">联系人：{{row.linkman}}</div>
            <div class="weui-media-box__desc">手机号：{{row.mobile}}</div>
            <div class="weui-media-box__desc">地址：{{row.addr}}</div>
			<div class="weui-media-box__desc">商户号:{{row.mchnt_cd}}</div>
			<div class="weui-media-box__desc">终端号：{{row.term_id}}</div>
			<div class="weui-media-box__desc">随机验证码：{{row.capacha}}</div>
            <div class="weui-media-box__desc">审核备注：{{row.checked_reason}}</div>
            <ul class="weui-media-box__info">
                <li class="weui-media-box__info__meta">创建时间：{{row.created_time}}</li>
            </ul>
			<ul class="weui-media-box__info">
				<li class="weui-media-box__info__meta">创建人：{{row.expand_nm}}</li>
			</ul>
        </div>
        {{/each}}
    </script>
    <script>
    var query = $$.parseQueryString();
    var operateType;
    var searchPage = weui.searchPage('#search-page', {
        resultTpl: '#result-template',
        loader: onSearch,
        onInput: function() {
            console.log(this, arguments);
        },
        onClickItem: function(row) {
            console.log(this, arguments);
            // weui.page.back();
            showActions(row);
        }
    }).search();

    function onSearch(param, success, error) {
        var queryParams = $.extend(param, query);
        $$.request('/action/bm/term-info/search_move', queryParams, {
            success: function(data) {
                if (data.errcode == 0) {
                    success(data.rows);
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {
                error();
            }
        });
    }

    function onPreview(param) {
        weui.page.show('#preview-page');

        $$.request('/action/bm/term-info/view', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    data.data.equi_type_nm = $$.formatField($$.param['equi_type'], data.data.equi_type);
                    data.data.term_status_nm = $$.formatField($$.param['term_status'], data.data.term_status);
                    for (var name in data.data) {
                        $('#preview-' + name).html(data.data[name]);
                    }
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onView(param) {
        weui.page.show('#detail-page');

        $$.request('/action/bm/term-info/view', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.form.load('#form', data.data);
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onDelete(param) {
        $$.request('/action/bm/term-info/delete', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        searchPage.search();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function showActions(row) {
        var actions = [{
            label: '查看',
            onClick: function() {
                console.log(this, arguments);
                onPreview(row);
                $('#back-btn').show().siblings().hide();
            }
        }]

        if ($.inArray(row.proc_st, ['8', '9', 'A']) >= 0) {
            actions.push({
                label: '编辑',
                onClick: function() {
                    console.log(this, arguments);
                    operateType = 'update';
                    onView(row);
                    $('#back-btn').show().siblings().show();
                }
            });
        }

        if (row.oper_in == 'I' && $.inArray(row.proc_st, ['9', 'A']) >= 0) {
            actions.push({
                label: '删除',
                onClick: function() {
                    console.log(this, arguments);
                    weui.confirm('确认要删除?', function() {
                        onDelete(row);
                    });
                }
            });
        }
        actions.push({
            label: '终端参数',
            onClick: function() {
                console.log(this, arguments);
                window.location.href = 'term-param.html?' + $.param({
                    term_no: row.term_no
                });
            }
        });
		if (row.proc_st = '8' && row.mchnt_cd != '' && row.equi_type != '9') {
            actions.push({
                label: '快速装机',
                onClick: function() {
                    console.log(this, arguments);
                    window.location.href = 'quick-install.html?' + $.param({
						term_no: row.term_no
					});
                }
            });
        }
        weui.actionSheet(actions, [{
            label: '取消',
            onClick: function() {
                console.log(this, arguments);
            }
        }]);
    }

    // 失去焦点时检测
    weui.form.checkIfBlur('#form', $$.rules);

    function onSubmit() {
        if (!weui.form.validate('#form', $$.rules)) return;
        var param = $('#form').serializeObject();

        $$.request('/action/bm/term-info/' + operateType, param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        searchPage.search();
                        weui.page.back();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onClickAdd() {
        operateType = 'create';
        weui.page.show('#detail-page');
        weui.form.clear('#form');
        weui.form.load('#form', {
            mchnt_id: query.mchnt_id
        });
		$('#term_num').show();
		$('input[name="term_num"]').val(1);
        $('#back-btn').show().siblings().show();
		$$.request('/action/bm/mchnt-base-info/view', {mchnt_id: query.mchnt_id}, {
            success: function(data) {
                if (data.errcode == 0) {
                    $('input[name="linkman"]').val(data.data.linkman);
					$('input[name="mobile"]').val(data.data.mobile);
					$('input[name="telno"]').val(data.data.telno);
					$('input[name="shop_name"]').val(data.data.mchnt_abbr);
                } else {
					
                }
            },
            error: function() {}
        });
        getLocation(function (addr) {
            setPickerValues('#city-picker', districtData, [addr.province,addr.city,addr.district]);
            $('#addr').val(addr.street+addr.streetNumber);
        });
    }

    function setPickerValues(target, items, arr) {
        var result = [];
        
        function getValue(items, depth) {
            for (var i = 0; i < items.length; i++) {
                if(items[i].text == arr[depth]) {
                    result[depth] = items[i].value;
                    if(items[i].children && items[i].children.length) {
                        getValue(items[i].children, depth+1);   
                    }
                    break;
                }
            }
        }

        getValue(items, 0);

        var $target = $(target);
        var $temp = $target;
        for (var i = 0; i < result.length; i++) {
            $temp = $temp.next();
            $temp.val(result[i]);
        }
        $target.val(arr.join(' ')).change(); //触发change

        return result;
    }

    function getLocation(success) {
        var geolocation = new BMap.Geolocation();
        geolocation.getCurrentPosition(function(r) {
            if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                
                var geoc = new BMap.Geocoder();
                var pt = r.point;

                geoc.getLocation(pt, function(rs) {
                    console.log(this, arguments);
                    // var addComp = rs.addressComponents;
                    // alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
                    if(success) success(rs.addressComponents);
                });
            } else {
                console.log(this, arguments);
            }
        }, {
            enableHighAccuracy: true
        });
    }

    $(function() {
        if(query.mchnt_id) {
            $('#add-btn').removeClass('hide').on('click', onClickAdd);
        }
        $('#submit-btn').on('click', onSubmit);

        //init component
        $('#city-picker').on('focus', function() {
            $$.showPicker(this, districtData);
        });

        //        $('#date-picker').on('focus', function() {
        //            $$.showDatePicker(this);
        //        });
        //        

        $$.request('/action/bm/parameter/list', {
            term_inves: '1',
            equi_type: '1'
        }, {
            success: function(data) {
                if (data.errcode == 0) {
                    $('#term-inves-select2').on('focus', function() {
                        $$.showSelect2(this, data.term_inves, {
                            title: '搜索终端投资方',
                        });
                    });

                    $('#equi-type-select2').on('focus', function() {
                        $$.showSelect2(this, data.equi_type, {
                            title: '搜索机具类型',
                        });
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            }
        });

        $('#expand-inst-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索拓展方',
                url: '/action/bm/expand-inst/search'
            }).search();
        });

        $('#expand-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索拓展人',
                url: '/action/bm/expand/search'
            }).search();
        });
    });
    </script>
</body>

</html>
