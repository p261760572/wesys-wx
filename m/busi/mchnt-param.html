<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>商户参数</title>
    <link rel="stylesheet" href="../js/lib/weuijs/style/weuijs.css">
    <link rel="stylesheet" href="../css/ui-base.css">
    <style type="text/css">

    </style>
</head>

<body>
    <div id="search-page" class="page page_show">
        <div class="weui-search-bar">
            <a id="add-btn" href="javascript:" class="search-bar__btn hide">新增</a>
            <form class="weui-search-bar__form" method="post" action="">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" name="search" placeholder="搜索">
                    <a href="javascript:" class="weui-icon-clear"></a>
                </div>
                <label class="weui-search-bar__label">
                    <i class="weui-icon-search"></i>
                    <span>搜索商户参数</span> </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn">取消</a>
        </div>
        <div class="weui-cells searchbar-result">
        </div>
    </div>
    <div id="detail-page" class="page">
        <form id="form">
            <input type="hidden" name="rec_id">
            <input type="hidden" name="oper_in">
            <input type="hidden" name="proc_st">
            <div class="weui-cells__title">商户参数</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">客户号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_id" required="" placeholder="请输入终端标识">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户参数ID<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_param_id" required="" placeholder="请输入商户参数ID">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">收单机构<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="acq_inst_nm" required="" placeholder="请选择收单机构" id="acq-inst-select2">
                        <input type="hidden" name="acq_inst_id">
                    </div>
                </div>
                <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">业务类型<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" name="busi_type_nm" required="" missingTips="请选择业务类型" id="busi-type">
                        <input type="hidden" name="busi_type">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户号</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_cd" placeholder="请输入商户号">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户名称</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_name" placeholder="请输入商户名称">
                    </div>
                </div>
                <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">账户类型<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select" name="account_type" required missingTips="请选择证件类型">
                            <option value="1">对私</option>
                            <option value="2">对公</option>
                        </select>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">开户名称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="account_name" required="" placeholder="请输入开户名称">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">开户支行<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="account_bank_branch_nm" placeholder="请选择开户支行" id="account-bank-branch-select2">
                        <input type="hidden" required="" name="account_bank_branch_cd">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">银行账号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="account_no" required="" placeholder="请输入银行账号">
                    </div>
                </div>
                <div class="weui-cell weui-cell_select weui-cell_select-after hide">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">信用卡开关<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select" name="credit_flag" required missingTips="请选择证件类型">
                            <option value="1">开</option>
                            <option value="0">关</option>
                        </select>
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">信用卡笔限额</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="credit_card_limit" placeholder="请输入信用卡笔限额">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">信用卡日限额</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="credit_date_limit" placeholder="请输入信用卡日限额">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">借记卡笔限额</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="debit_card_limit" placeholder="请输入借记卡笔限额">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">借记卡日限额</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="debit_date_limit" placeholder="请输入借记卡日限额">
                    </div>
                </div>
                <div class="weui-cell" id="mcc-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">MCC</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mcc_nm" placeholder="请选择商户类别" id="mcc-select2">
                        <input type="hidden" name="mcc">
                    </div>
                </div>
                <div class="weui-cell hide">
                    <div class="weui-cell__hd">
                        <label class="weui-label">MCC18</label>
                    </div>
                    <div class="weui-cell__bd">
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" name="mcc18_nm" placeholder="请选择商户类别" id="mcc18-select2">
                            <input type="hidden" name="mcc18">
                        </div>
                    </div>
                </div>
                <div class="weui-cell hide" id="debit-card-fee-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">借记卡手续费<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="debit_card_fee_nm" required="" placeholder="请选择借记卡手续费" id="debit-card-fee-select2">
                        <input type="hidden" name="debit_card_fee">
                    </div>
                </div>
                <div class="weui-cell hide" id="credit-card-fee-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">贷记卡手续费<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="credit_card_fee_nm" required="" placeholder="请选择贷记卡手续费" id="credit-card-fee-select2">
                        <input type="hidden" name="credit_card_fee">
                    </div>
                </div>
                <div class="weui-cell weui-cell_vcode hide" id="fee-cell">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">手续费<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_busi" name="fee" type="text" required="" pattern="^\d+\.?\d*$" placeholder="请输入手续费千分比" invalidTips="请输入正确的手续费">
                    </div>
                    <div class="weui-cell__ft">
                        <button class="weui-vcode-btn">‰</button>
                    </div>
                </div>
                <div class="weui-cell weui-cell_select weui-cell_select-after hide">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">参数状态<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select" name="status" required missingTips="请选择参数状态">
                            <option value="1">正常</option>
                            <option value="0">注销</option>
                        </select>
                    </div>
                </div>
                <!--div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">拓展方<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="expand_inst_nm" required="" placeholder="请选择拓展方" id="expand-inst-select2">
                        <input type="hidden" name="expand_inst_id">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">拓展人<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="expand_nm" required="" placeholder="请选择拓展人" id="expand-select2">
                        <input type="hidden" name="expand_id">
                    </div>
                </div-->
            </div>
            <div class="weui-btn-area btn-area">
                <a id="back-btn" href="javascript:" class="weui-btn weui-btn_default" onclick="weui.page.back()">返回</a>
                <a id="submit-btn" href="javascript:" class="weui-btn weui-btn_primary">提交</a>
            </div>
        </form>
    </div>
    <div id="preview-page" class="page">
        <div class="weui-form-preview">
            <div class="weui-form-preview__hd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">商户参数</label>
                </div>
            </div>
            <div class="weui-form-preview__bd">
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">商户参数ID</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_param_id"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">业务类型</label>
                    <span class="weui-form-preview__value" id="preview-busi_type_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">收单机构</label>
                    <span class="weui-form-preview__value" id="preview-acq_inst_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">商户号</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_cd"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">商户名称</label>
                    <span class="weui-form-preview__value" id="preview-mchnt_name"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">账户类型</label>
                    <span class="weui-form-preview__value" id="preview-account_type_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">开户名称</label>
                    <span class="weui-form-preview__value" id="preview-account_name"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">开户银行</label>
                    <span class="weui-form-preview__value" id="preview-account_bank"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">开户银行省</label>
                    <span class="weui-form-preview__value" id="preview-account_province"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">开户银行市</label>
                    <span class="weui-form-preview__value" id="preview-account_city"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">开户支行</label>
                    <span class="weui-form-preview__value" id="preview-account_bank_branch_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">银行账号</label>
                    <span class="weui-form-preview__value" id="preview-account_no"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">信用卡开关</label>
                    <span class="weui-form-preview__value" id="preview-credit_flag"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">信用卡笔限额</label>
                    <span class="weui-form-preview__value" id="preview-credit_card_limit"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">信用卡日限额</label>
                    <span class="weui-form-preview__value" id="preview-credit_date_limit"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">借记卡笔限额</label>
                    <span class="weui-form-preview__value" id="preview-debit_card_limit"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">借记卡日限额</label>
                    <span class="weui-form-preview__value" id="preview-debit_date_limit"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">MCC</label>
                    <span class="weui-form-preview__value" id="preview-mcc_nm"></span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">MCC18</label>
                    <span class="weui-form-preview__value" id="preview-mcc18_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">借记卡手续费</label>
                    <span class="weui-form-preview__value" id="preview-debit_card_fee_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">贷记卡手续费</label>
                    <span class="weui-form-preview__value" id="preview-credit_card_fee_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">当面付手续费</label>
                    <span class="weui-form-preview__value"><span id="preview-fee"></span>‰</span>
                </div>
                <div class="weui-form-preview__item hide">
                    <label class="weui-form-preview__label">参数状态</label>
                    <span class="weui-form-preview__value" id="preview-status"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">拓展方</label>
                    <span class="weui-form-preview__value" id="preview-expand_inst_nm"></span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">拓展人</label>
                    <span class="weui-form-preview__value" id="preview-expand_nm"></span>
                </div>
            </div>
            <div class="weui-form-preview__ft">
                <a class="weui-form-preview__btn weui-form-preview__btn_default" href="javascript:" onclick="weui.page.back()">返回</a>
                <!-- <button type="submit" class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:">编辑</button> -->
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../js/lib/zepto.js"></script>
    <script type="text/javascript" src="../js/lib/weuijs/weuijs.js"></script>
    <script type="text/javascript" src="../js/param.js"></script>
    <script id="result-template" type="text/html">
        {{each rows as row i}}
        <a class="weui-cell weui-cell_access searchbar-result__item" href="javascript:;" data-index="{{total+i}}">
            <div class="weui-cell__bd weui-cell_primary">
                <p>{{row.mchnt_name}}</p>
            </div>
            <div class="weui-cell__ft" style="color:#f6383a;">{{row.proc_st_nm}}</div>
        </a>
        <div class="weui-media-box weui-media-box_text">
            <div class="weui-media-box__desc">商户号：{{row.mchnt_cd}}</div>
            <div class="weui-media-box__desc">收单机构：{{row.acq_inst_nm}}</div>
            <div class="weui-media-box__desc">开户行：{{row.account_bank_branch_nm}}</div>
			<div class="weui-media-box__desc">业务类型：{{row.busi_type_nm}}</div>
            <div class="weui-media-box__desc">审核备注：{{row.checked_reason}}</div>
            <ul class="weui-media-box__info">
                <li class="weui-media-box__info__meta">创建时间：{{row.created_time}}</li>
            </ul>
			<ul class="weui-media-box__info">
				<li class="weui-media-box__info__meta">创建人：{{row.expand_nm}}</li>
			</ul>
        </div>
        {{/each}}
    </script>
    <script>
    var query = $$.parseQueryString();
    var operateType;
    var searchPage = weui.searchPage('#search-page', {
        resultTpl: '#result-template',
        loader: onSearch,
        onInput: function() {
            console.log(this, arguments);
        },
        onClickItem: function(row) {
            console.log(this, arguments);
            // weui.page.back();
            showActions(row);
        }
    }).search();

    function onSearch(param, success, error) {
        var queryParams = $.extend(query, param);
        $$.request('/action/bm/mchnt-param/search', queryParams, {
            success: function(data) {
                if (data.errcode == 0) {
                    success(data.rows);
                } else {
                    weui.alert(data.errmsg, error, {
                        title: '提示'
                    });
                }
            },
            error: function() {
                error();
            }
        });
    }

    function onPreview(param) {
        weui.page.show('#preview-page');

        $$.request('/action/bm/mchnt-param/view', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    data.data.busi_type_nm = $$.formatField($$.param['busi_type'], data.data.busi_type);
                    data.data.account_type_nm = $$.formatField($$.param['account_type'], data.data.account_type);
                    for (var name in data.data) {
                        $('#preview-' + name).html(data.data[name]);
                    }
					
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onView(param) {
        weui.page.show('#detail-page');

        $$.request('/action/bm/mchnt-param/view', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.form.load('#form', data.data);
                    $('#busi-type').change();
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onDelete(param) {
        $$.request('/action/bm/mchnt-param/delete', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        searchPage.search();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function showActions(row) {
        var actions = [{
            label: '查看',
            onClick: function() {
                console.log(this, arguments);
                onPreview(row);
                $('#back-btn').show().siblings().hide();
            }
        }]

        if ($.inArray(row.proc_st, ['8', '9', 'A']) >= 0) {
            actions.push({
                label: '编辑',
                onClick: function() {
                    console.log(this, arguments);
                    operateType = 'update';
                    onView(row);
                    $('#back-btn').show().siblings().show();
                }
            });
        }

        if (row.oper_in == 'I' && $.inArray(row.proc_st, ['9', 'A']) >= 0) {
            actions.push({
                label: '删除',
                onClick: function() {
                    console.log(this, arguments);
                    weui.confirm('确认要删除?', function() {
                        onDelete(row);
                    });
                }
            });
        }

        actions.push({
            label: '终端参数',
            onClick: function() {
                console.log(this, arguments);
                window.location.href = 'term-param.html?' + $.param({
					mchnt_id: row.mchnt_id,
                    mchnt_param_id: row.mchnt_param_id
                });
            }
        });

        weui.actionSheet(actions, [{
            label: '取消',
            onClick: function() {
                console.log(this, arguments);
            }
        }]);
    }

    // 失去焦点时检测
    weui.form.checkIfBlur('#form', $$.rules);

    function onSubmit() {
        if (!weui.form.validate('#form', $$.rules)) return;
        var param = $('#form').serializeObject();
		param = $.extend(query, param);
        $$.request('/action/bm/mchnt-param/' + operateType, param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        searchPage.search();
                        weui.page.back();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function onClickAdd() {
        operateType = 'create';
        weui.page.show('#detail-page');
        weui.form.clear('#form');
        weui.form.load('#form', {
            mchnt_id: query.mchnt_id,
            busi_type: 'SD',
            account_type: '1'
        });
        $('#busi-type').change();
        $('#back-btn').show().siblings().show();
    }

    $(function() {
        if (query.mchnt_id) {
            $('#add-btn').removeClass('hide').on('click', onClickAdd);
        }
        $('#submit-btn').on('click', onSubmit);

        //init component
        // $('#city-picker').on('focus', function() {
        //     $$.showPicker(this, districtData);
        // });

        // $('#date-picker').on('focus', function() {
        //     $$.showDatePicker(this);
        // });

        $('#busi-type').on('change', function() {
            var value = $(this).val();
            $('#debit-card-fee-cell,#credit-card-fee-cell,#fee-cell').addClass('hide');
            if (value == 'DMF') {
                $('#fee-cell').removeClass('hide');
            } else {
                $('#debit-card-fee-cell,#credit-card-fee-cell').removeClass('hide');
            }
        });

        $('#acq-inst-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索收单机构',
                valueField: 'acq_inst_id',
                textField: 'acq_inst_nm',
                url: '/action/bm/acq-inst/search'
            }).search();
        });

		$('#acq-inst-select2').on('change', function() {
			var acq_inst = $('#acq-inst-select2').next().val();
			$$.request('/action/bm/acq-inst-busi/list', {
				acq_inst_id: acq_inst
			}, {
				success: function(data) {
					if (data.errcode == 0) {
						$$.showSelect2('#busi-type', data.rows, {
							title: '',
							valueField: 'busi_type',
							textField: 'busi_type_nm'
						}).search();
					} 
				}
			});
			
        });
		
        $('#account-bank-branch-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索开户支行',
                valueField: 'bank_branch_cd',
                textField: 'bank_branch_nm',
                url: '/action/bm/bank-branch/search'
            }).search();
        });

        $('#mcc-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索商户类别',
                valueField: 'mcc',
                textField: 'mcc_nm',
                url: '/action/bm/mcc/search'
            }).search();
        });

        $('#mcc18-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索商户类别',
                valueField: 'mcc',
                textField: 'mcc_nm',
                url: '/action/bm/mcc/search'
            }).search();
        });

        $('#debit-card-fee-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索手续费',
                valueField: 'fee_cd',
                textField: 'fee_nm',
                url: '/action/bm/fee/search',
                queryParams: {
                    // debit_flag: '1'
                }
            }).search();
        });

        $('#credit-card-fee-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索手续费',
                valueField: 'fee_cd',
                textField: 'fee_nm',
                url: '/action/bm/fee/search',
                queryParams: {
                    credit_flag: '1'
                }
            }).search();
        });

        $('#expand-inst-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索拓展方',

                url: '/action/bm/expand-inst/search'
            }).search();
        });

        $('#expand-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索拓展人',
                url: '/action/bm/expand/search'
            }).search();
        });
    });
    </script>
</body>

</html>
