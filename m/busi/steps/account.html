<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>结算信息</title>
    <link rel="stylesheet" href="../../js/lib/weuijs/style/weuijs.min.css">
    <link rel="stylesheet" href="../../css/ui-base.css">
</head>

<body>
   <div class="page page_show">
    <form id="form">
        <!-- 填写结算信息开始 -->
        <div class="weui-cells__title">结算账户</div>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell weui-cell_select weui-cell_select-after">
                <div class="weui-cell__hd">
                    <label for="" class="weui-label">账户类型<span class="required">*</span></label>
                </div>
                <div class="weui-cell__bd">
                    <select class="weui-select" name="account_type" id="account_type">
                        <option value="2">对公账户</option>
                        <option value="1">对私账户</option>
                    </select>
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="weui-uploader required recognize" data-type="zhzm">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">账户正面照片<span class="required">*</span></p>
                        </div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files">
                                <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                            </ul>
                            <div class="weui-uploader__input-box">
                                <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cell weui-cell_switch">
                <div class="weui-cell__bd" style="color: gray">非法人入账资料补充</div>
                <div class="weui-cell__ft">
                    <input class="weui-switch" type="checkbox" id="s1"/>
                </div>
            </div>
            <div class="weui-cell hide ffrrz">
                <div class="weui-cell__bd">
                    <div class="weui-uploader recognize" data-type="sfzzm">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">非法人入账证件正面照</p>
                        </div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files">
                                <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                            </ul>
                            <div class="weui-uploader__input-box">
                                <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cell hide ffrrz">
                <div class="weui-cell__bd">
                    <div class="weui-uploader" data-type="sfzfm">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">非法人入账证件反面照</p>
                        </div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files">
                                <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                            </ul>
                            <div class="weui-uploader__input-box">
                                <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cell hide ffrrz">
                <div class="weui-cell__bd">
                    <div class="weui-uploader" data-type="rzsqs">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">非法人入账授权书</p>
                        </div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files">
                                <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                            </ul>
                            <div class="weui-uploader__input-box">
                                <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">账户户名<span class="required">*</span></label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input" id="account_name" name="account_name" required="" type="text" placeholder="请输入账户户名">
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">银行账号<span class="required">*</span></label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input" name="account_no" id="account_no" required="" type="number" placeholder="请输入银行账号" style="font-weight:bold; font-size:20px; color: red;">
                </div>
            </div>
            <!--div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">开户银行</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" placeholder="请选择开户银行">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">开户银行城市</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" placeholder="请选择开户银行城市">
                    </div>
                </div-->
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label">开户支行<span class="required">*</span></label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input" type="text" required="" name="account_bank_branch_nm" placeholder="请选择开户支行" id="account-bank-branch-select2">
                    <input type="hidden" required="" name="account_bank_branch_cd">
                </div>
            </div>
        </div>
        <!-- 填写结算信息结束 -->
        <div class="weui-btn-area btn-area">
            <a id="back-btn" href="javascript:" class="weui-btn weui-btn_default" onclick="prev()">上一步</a>
            <a id="submit-btn" href="javascript:" class="weui-btn weui-btn_primary">提交</a>
        </div>
    </form>
  </div>
    <!-- <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=mUs8UNiHRImGLNueae1Gd9PVdejrYdHC"></script> -->
    <script type="text/javascript" src="../../js/lib/zepto.min.js"></script>
    <script type="text/javascript" src="../../js/lib/weuijs/weuijs.min.js"></script>
    <script>
    var query = $$.parseQueryString();
    var operateType = query.operateType;
	var hash = window.location.hash;
    var uploaderData = [];

	var ocr_map = {
		'zhzm':{
			url:'/gateway/ocr/bankcard', 
			param: {}, 
			ret:[{tag: 'bank_card_number', target: '#account_no'}]
		},
		'sfzzm':{
			url: '/gateway/ocr/idcard', 
			param: {id_card_side: 'front'}, 
			ret: [
				{tag: 'name', target: '#account_name'}
			]
		},
	};
    
	function imageToDataUrl(url, callback, param) {
		var canvas = document.createElement("canvas");
		var ctx = canvas.getContext("2d");

		var img = new Image();
		img.onload = function () {        
			var w = img.width;
			var h = img.height;
			var dataURL;

			canvas.width = w;
			canvas.height = h;
			ctx.drawImage(img, 0, 0);

			var dataURL =  canvas.toDataURL('image/jpeg');
			console.log(dataURL);
			callback(dataURL, param);
		}
		img.src = url;		
	}
		
	function auto_recognize(data, param) {
		var Default = {
			image: data,
			serverid: param.serverid
		};
		$.extend(Default, ocr_map[param.elec_info_type].param || {});
		
		$.each(ocr_map[param.elec_info_type].ret, function(index, item) {
			$(item.target).attr('readonly', true);
		});
		
		$$.request(ocr_map[param.elec_info_type].url, Default, {
			success: function(data) {
				if (data.errcode == 0) {
					$.each(ocr_map[param.elec_info_type].ret, function(index, item) {
						if(data.data[item.tag] && data.data[item.tag]!=undefined) {
							if(item.callback) {
								item.callback(data.data[item.tag]);
							}
							$(item.target).val(data.data[item.tag]);
						}
					});
				} else {
					
				}
				
			}
		});
		
		$.each(ocr_map[param.elec_info_type].ret, function(index, item) {
			$(item.target).removeAttr('readonly');
		});
	}
		
    function initUploader(selector, elec_info_type) {
		var target = $(selector);
        weui.ajaxUploader(selector, {
            url: $$.wrapUrl('/action/upload'),
            auto: true,
            type: 'file',
            fileVal: 'file',
            compress: {
                width: 1600,
                height: 1600,
                quality: 0.92
            },
            onBeforeSend: function(data, headers) {
                console.log(this, arguments);
                // return false; // 阻止文件上传
            },
            onSuccess: function(ret) {
                uploaderData[this.id] = {
					status: '1',
					serverid: ret.serverid,
					elec_info_type: elec_info_type
				};
				if(target.hasClass('recognize')) {
					var url =  $$.wrapUrl('/action/uploads/') + ret.serverid;
					imageToDataUrl(url, auto_recognize, uploaderData[this.id]);
				}
            },
            onError: function(err) {
                console.log(this, err);
            }
        });
    }

	function prev() {
		flows.prev(query);
	}
		
	function checkMustPic() {
		var check = true;
		$('#form').find('.weui-uploader.required').each(function(index, item){
			var target = $(this);
			if(target.find('.weui-uploader__file').length == 0 ||
				target.find('.weui-uploader__file').attr('data-id') == undefined ||
				target.find('.weui-uploader__file').attr('data-id') == null) {
				if(!(target.closest('.weui-cell').hasClass('hide'))) {
					check = false;
					return check;
				}
			}
		});
		return check;
	}
		
    function onSubmit() {
        if (!weui.form.validate('#form', $$.rules)) return;
		if (!checkMustPic()) {
			weui.alert('请完善电子资料', {
				title: '提示'
			});
			return;
		}
        var param = $('#form').serializeObject();
		
		if (hash.substr(0, 6) == '#step/') {
            var arr = hash.substr(6).split('/');
			param['flow'] = arr[1];
			param['step'] = parseInt(arr[2]);
		}
        var elec_info = [];

        $('#form').find('.weui-uploader__file').forEach(function(item) {
            var id = parseInt($(item).attr('data-id'));
			if(id != undefined && id != null) {
				elec_info.push(uploaderData[id]);
			}
        });

        param.elec_info = elec_info;

        param = $.extend({}, query, param);

        $$.request('/action/bm/mchnt-param/save-account', param, {
            success: function(data) {
                if (data.errcode == 0) {
					weui.toast('操作成功', function() {
						flows.next({
							mchnt_param_id: data.data.mchnt_param_id
						});
                    });
                    
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            }
        });
    }

	function LoadForm() {
		if(query.mchnt_id && query.mchnt_id != "") {
			$$.request('/action/bm/mchnt-base-info/view', query, {
				success: function(data) {
					if (data.errcode == 0) {
						var name = ($('#account_type').val() == '1')?data.data.cert_name:data.data.mchnt_abbr;
						$('input[name="account_name"]').val(name);
					} else {

					}
				},
				error: function() {}
			});
		}
	}
		
    $(function() {
		history.pushState(null, null, document.URL);
        window.addEventListener('popstate', function () {
            history.pushState(null, null, document.URL);
        });
        $('#submit-btn').on('click', onSubmit);
		LoadForm();
        $('#form').find('.weui-uploader').each(function() {
            initUploader(this, $(this).attr('data-type'));
        });
		$('#s1').on('change', function() {
			if ($(this).prop('checked')) {
				$('div.ffrrz').removeClass('hide');
			} else {
				$('div.ffrrz').addClass('hide');
			}
		});
        $('#account-bank-branch-select2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索开户支行',
                valueField: 'bank_branch_cd',
                textField: 'bank_branch_nm',
                url: '/action/bm/bank-branch/search'
            }).search();
        });
    });
    </script>
</body>

</html>
