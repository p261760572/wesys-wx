<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>基本信息</title>
    <link rel="stylesheet" href="../../js/lib/weuijs/style/weuijs.min.css">
    <link rel="stylesheet" href="../../css/ui-base.css">
</head>

<body>
    <form id="form">
        <div title="填写基本信息">
            <div class="weui-cells__title">联系信息</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系人<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="linkman" required="" pattern="" placeholder="请输入联系人">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">手机号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mobile" required="" placeholder="请输入手机号" validType="mobile" invalidTips="请输入有效的手机号">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">常用邮箱</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="email" placeholder="请输入常用邮箱" validType="email" invalidTips="请输入有效的邮箱">
                    </div>
                </div>
            </div>
            <div class="weui-cells__title">经营信息</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户简称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="mchnt_abbr" required="" placeholder="请输入商户简称">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系电话</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="telno" placeholder="请输入联系电话" validType="telno" invalidTips="请输入有效的电话号码">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">所在地区<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="district_name" required="" placeholder="请选择所在地区" id="city-picker" readonly>
                        <input type="hidden" name="province">
                        <input type="hidden" name="city">
                        <input type="hidden" name="district">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">详细地址<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="addr" required="" placeholder="请输入详细地址" id="addr">
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-btn-area btn-area">
            <a id="back-btn" href="javascript:" class="weui-btn weui-btn_default" onclick="onBack()">返回</a>
            <a id="submit-btn" href="javascript:" class="weui-btn weui-btn_primary">下一步</a>
        </div>
    </form>
    <script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=mUs8UNiHRImGLNueae1Gd9PVdejrYdHC"></script>
    <script type="text/javascript" src="../../js/lib/zepto.min.js"></script>
    <script type="text/javascript" src="../../js/lib/weuijs/weuijs.min.js"></script>
    <script type="text/javascript" src="../../js/district.js"></script>
    <script>
    var query = $$.parseQueryString();
    var operateType = 'create-save';
		
	var hash = window.location.hash;
    function onBack() {
        window.location.href="../../index.html";
    }

    function onSubmit() {
        if (!weui.form.validate('#form', $$.rules)) return;
        var param = $('#form').serializeObject();
		param = $.extend({}, query, param);
		if (hash.substr(0, 6) == '#step/') {
            var arr = hash.substr(6).split('/');
			param['flow'] = arr[0];
			param['step'] = parseInt(arr[1]);
		}
        $$.request('/action/bm/mchnt-base-info/' + operateType, param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        window.location.href = 'select-busi.html?' + $.param(query, {
                            mchnt_id: data.data.mchnt_id
                        });
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }

    function setPickerValues(target, items, arr) {
        var result = [];

        function getValue(items, depth) {
            for (var i = 0; i < items.length; i++) {
                if (items[i].text == arr[depth]) {
                    result[depth] = items[i].value;
                    if (items[i].children && items[i].children.length) {
                        getValue(items[i].children, depth + 1);
                    }
                    break;
                }
            }
        }

        getValue(items, 0);

        var $target = $(target);
        var $temp = $target;
        for (var i = 0; i < result.length; i++) {
            $temp = $temp.next();
            $temp.val(result[i]);
        }
        $target.val(arr.join(' ')).change(); //触发change

        return result;
    }

    function getLocation(success) {
        var geolocation = new BMap.Geolocation();
        geolocation.getCurrentPosition(function(r) {
            if (this.getStatus() == BMAP_STATUS_SUCCESS) {

                var geoc = new BMap.Geocoder();
                var pt = r.point;

                geoc.getLocation(pt, function(rs) {
                    console.log(this, arguments);
                    // var addComp = rs.addressComponents;
                    // alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
                    if (success) success(rs.addressComponents);
                });
            } else {
                console.log(this, arguments);
            }
        }, {
            enableHighAccuracy: true
        });
    }
	function LoadForm() {
		if(query.mchnt_id && query.mchnt_id != "") {
			$$.request('/action/bm/mchnt-base-info/view', query, {
				success: function(data) {
					if (data.errcode == 0) {
						weui.form.load('#form', data.data);
					} else {

					}
				},
				error: function() {}
			});
		}
	}
    $(function() {
		history.pushState(null, null, document.URL);
        window.addEventListener('popstate', function () {
            history.pushState(null, null, document.URL);
        });
        $('#submit-btn').on('click', onSubmit);
        $('#city-picker').on('focus', function() {
            $$.showPicker(this, districtData);
        });
        // 失去焦点时检测
        weui.form.checkIfBlur('#form', $$.rules);
		
		LoadForm();
        getLocation(function(addr) {
            setPickerValues('#city-picker', districtData, [addr.province, addr.city, addr.district]);
            $('#addr').val(addr.street + addr.streetNumber);
        });
    });
    </script>
</body>

</html>
