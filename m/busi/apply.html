<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>业务申请</title>
    <link rel="stylesheet" href="../js/lib/weuijs/style/weuijs.min.css">
    <style type="text/css">
		body {
			background-color: #f8f8f8;
		}
		.required {
			color: red;
		}
		.weui-cell__bd {
			position: relative;
		}
    </style>
</head>

<body>
   	<div id="flow">
        <input name="rec_id" type="hidden">
        <div class="flow__step" title="填写基本信息">
            <!-- 填写基本信息开始 -->
            <div class="weui-cells__title">联系信息</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系人姓名<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" name="linkman" type="text" placeholder="请输入联系人姓名" required>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd"> 
                        <label class="weui-label">手机号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" type="number" name="mobile" validType="mobile" invalidTips="请输入有效的手机号" placeholder="请输入手机号" required>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd"> 
                        <label class="weui-label">常用邮箱</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" type="text" name="email" invalidType="email" invalidTips="请输入有效的邮箱" placeholder="请输入常用邮箱">
                    </div>
                </div>
            </div>
            <div class="weui-cells__title">经营信息</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户名称<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base for_busi" name="mchnt_name" type="text" placeholder="请输入商户名称" required>
                    </div>
                </div>
                <!--div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">联系电话</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="tel" placeholder="请输入联系电话">
                    </div>
                </div-->
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">所在地区<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" id="district" required="" name="location" type="text" placeholder="请选择所在地区" readonly>
                        <input class="for_base" type="hidden" name="province" value="43">
                        <input class="for_base" type="hidden" name="city" value="01">
                        <input class="for_base" type="hidden" name="district">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">详细地址<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" name="addr" id="addr" required="" type="text" placeholder="请输入详细地址">
                    </div>
                </div>
            </div>
            <!-- 填写基本信息结束 -->
        </div>
        
        <div class="flow__step" title="填写商户信息">
            <!-- 填写商户信息开始 -->
            <!-- <div class="weui-cells__title">营业执照</div> -->
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">营业执照</div>
                    <div class="weui-cell__ft">
                        <input class="weui-switch" type="checkbox" checked="" id="s10">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">营业执照正面照片</p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="01">
                                   <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            		<li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li> -->
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">商户名称</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" placeholder="请输入商户名称">
                    </div>
                </div-->
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">营业执照号</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" name="license_no" type="text" placeholder="请输入营业执照号" onkeyup="this.value=this.value.toUpperCase()">
                    </div>
                </div>
            </div>
            <div class="weui-cells__title">企业法人/证件持有人</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">证件类型</label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select for_base" name="cert_type" id="cert_type" value="01">
                        	<option value="01">身份证</option>
                        </select>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">身份证正面照片<span class="required">*</span></p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="03">
                                    <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">身份证反面照片</p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="99">
                                    <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件姓名<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" name="cert_name" required="" type="text" placeholder="请输入证件姓名">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">证件号码<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_base" name="cert_id" required="" type="text" placeholder="请输入证件号码" validType="idnum" invalidTips="请输入有效的证件号码">
                    </div>
                </div>
            </div>
            <!-- 填写商户信息结束 -->
        </div>
        
        <div class="flow__step" title="填写结算信息">
            <!-- 填写结算信息开始 -->
            <div class="weui-cells__title">开通业务</div>
            <div class="weui-cells weui-cells_checkbox">
                <div>
                    <label class="weui-cell weui-check__label" for="s11">
                        <div class="weui-cell__hd">
                            <input type="checkbox" class="weui-check for_busi" id="s11" name="busi_type" value="SD">
                            <i class="weui-icon-checked"></i>
                        </div>
                        <div class="weui-cell__bd">
                            <p>银行卡收单</p>
                        </div>
                    </label>
                    <div class="weui-cell" style="display: none;">
                        <div class="weui-cell__hd">
                            <label for="" class="weui-label">借记卡手续费</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" id="debit_card_fee" name="debit_card_fee_text" placeholder="请选择借记卡手续费" readonly>
                            <input class="for_busi" type="hidden" name="debit_card_fee">
                        </div>
                    </div>
                    <div class="weui-cell" style="display: none;">
                        <div class="weui-cell__hd">
                            <label for="" class="weui-label">贷记卡手续费</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" id="credit_card_fee" name="credit_card_fee_text" placeholder="请选择贷记卡手续费" readonly>
                            <input class="for_busi" type="hidden" name="credit_card_fee">
                        </div>
                    </div>
                    <div class="weui-cell" style="display: none;">
                        <div class="weui-cell__hd">
                            <label for="" class="weui-label">收单机构</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" id="acq_inst_id" placeholder="请选择收单机构" readonly>
                            <input class="for_busi" type="hidden" name="acq_inst_id">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="weui-cell weui-check__label" for="s12">
                        <div class="weui-cell__hd">
                            <input type="checkbox" class="weui-check for_busi" name="busi_type" id="s12" value="DMF">
                            <i class="weui-icon-checked"></i>
                        </div>
                        <div class="weui-cell__bd">
                            <p>当面付</p>
                        </div>
                    </label>
                    <div class="weui-cell weui-cell_vcode" style="display: none;">
                        <div class="weui-cell__hd">
                            <label for="" class="weui-label">手续费</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input for_busi" name="fee" type="number" placeholder="请输入手续费千分比">
                        </div>
                        <div class="weui-cell__ft">
                            <button class="weui-vcode-btn">‰</button>
                        </div>
                    </div>
                    <div class="weui-cell" style="display: none;">
                        <div class="weui-cell__hd">
                            <label for="" class="weui-label">接入机构</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" id="acq_inst_id2" placeholder="请选择接入机构" readonly>
                            <input class="for_busi" type="hidden" name="plat_inst_id" value="48215500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cells__title">结算账户</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">账户类型<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <select class="weui-select for_busi" name="account_type" id="account_type" value="1">
                        	<option value="1">对公账户</option>
                        	<option value="2">对私账户</option>
                        </select>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__hd">
                                <p class="weui-uploader__title">账户正面照片<span class="required">*</span></p>
                            </div>
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="16">
                                    <!-- <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>
                            <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                                </ul>
                                <div class="weui-uploader__input-box">
                                    <input class="weui-uploader__input" type="file" accept="image/*" capture="camera">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">账户户名<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_busi" name="account_name" required="" type="text" placeholder="请输入账户户名">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">银行账号<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input for_busi" name="account_no" required="" type="number" placeholder="请输入银行账号">
                    </div>
                </div>
                <!--div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">开户银行</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" placeholder="请选择开户银行">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">开户银行城市</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" placeholder="请选择开户银行城市">
                    </div>
                </div-->
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label for="" class="weui-label">开户支行<span class="required">*</span></label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" required="" name="subbranch_name" id="subbranch_name" placeholder="请选择开户支行" readonly>
                        <input class="for_busi" type="hidden" name="account_bank_branch_cd">
                    </div>
                </div>
            </div>
            <!-- 填写结算信息结束 -->
        </div>
        <div class="flow__step" title="确认提交" id="save_all">
            <div class="weui-cells__title">基本信息</div>
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">联系信息</label>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">联系人姓名</label>
                        <span class="weui-form-preview__value" name="linkman"></span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">手机号</label>
                        <span class="weui-form-preview__value" name="mobile"></span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">常用邮箱</label>
                        <span class="weui-form-preview__value" name="email"></span>
                    </div>
                </div>
            </div>
            <!-- <br> -->
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">经营信息</label>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">商户名称</label>
                        <span class="weui-form-preview__value" name="mchnt_name"></span>
                    </div>
                    <!--div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">联系电话</label>
                        <span class="weui-form-preview__value" name="telno">联系电话</span>
                    </div-->
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">所在地区</label>
                        <span class="weui-form-preview__value" name="location"></span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">详细地址</label>
                        <span class="weui-form-preview__value" name="addr"></span>
                    </div>
                </div>
                <div class="weui-form-preview__ft">
                    <a class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:" onclick="flow.start(0)">修改</a>
                </div>
            </div>
            <div class="weui-cells__title">商户信息</div>
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">营业执照</label>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <!--div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">营业执照正面照片</label>
                        <span class="weui-form-preview__value">营业执照正面照片</span>
                    </div>
                    <!--div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">商户名称</label>
                        <span class="weui-form-preview__value">商户名称</span>
                    </div-->
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">营业执照号</label>
                        <span class="weui-form-preview__value" name="license_no"></span>
                    </div>
                </div>
            </div>
            <!-- <br> -->
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">企业法人/证件持有人</label>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <!--div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">身份证正面照片</label>
                        <span class="weui-form-preview__value">身份证正面照片</span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">身份证反面照片</label>
                        <span class="weui-form-preview__value">身份证反面照片</span>
                    </div-->
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">证件类型</label>
                        <span class="weui-form-preview__value" name="cert_type">身份证</span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">证件姓名</label>
                        <span class="weui-form-preview__value" name="cert_name"></span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">证件号码</label>
                        <span class="weui-form-preview__value" name="cert_id"></span>
                    </div>
                </div>
                <div class="weui-form-preview__ft">
                    <a class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:" onclick="flow.start(1)">修改</a>
                </div>
            </div>
            <div class="weui-cells__title">结算信息</div>
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">开通业务</label>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">银行卡收单</label>
                        <p class="weui-form-preview__value"><span name="debit_card_fee_text"></span>/<span name="credit_card_fee_text"></span></p>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">当面付</label>
                        <span class="weui-form-preview__value" name="fee"></span>
                    </div>
                </div>
            </div>
            <!-- <br> -->
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">结算账户</label>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">账户类型</label>
                        <span class="weui-form-preview__value" name="account_type">对公账户</span>
                    </div>
                    <!--div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">账户正面照片</label>
                        <span class="weui-form-preview__value"></span>
                    </div-->
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">账户名称</label>
                        <span class="weui-form-preview__value" name="account_name"></span>
                    </div>
                    <!--div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">开户银行</label>
                        <span class="weui-form-preview__value"></span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">开户银行城市</label>
                        <span class="weui-form-preview__value"></span>
                    </div-->
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">开户支行</label>
                        <span class="weui-form-preview__value" name="subbranch_name"></span>
                    </div>
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">银行账号</label>
                        <span class="weui-form-preview__value" name="account_no"></span>
                    </div>
                </div>
                <div class="weui-form-preview__ft">
                    <a class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:" onclick="flow.start(2)">修改</a>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../js/lib/zepto.min.js"></script>
    <script type="text/javascript" src="../js/lib/weuijs/weuijs.min.js"></script>
    <script type="text/javascript" src="../js/district.js"></script>
    <script src="http://api.map.baidu.com/api?v=1.3" type="text/javascript"></script>
    <script type="text/javascript">
	var getLocation = function (successFunc, errorFunc) { 
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function (position) {
				var lat = position.coords.latitude;
				var lon = position.coords.longitude;
				//var map = new BMap.Map("container");   // 创建Map实例
				var point = new BMap.Point(lon, lat); // 创建点坐标
				var gc = new BMap.Geocoder();
				gc.getLocation(point, function (rs) {
					var addComp = rs.addressComponents;
					//当前定位城市
					//alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street);
					if (successFunc != undefined)
						successFunc(addComp);
				});
			},
			function (error) {
				switch (error.code) {
					case 1:
						alert("位置服务被拒绝。");
						break;
					case 2:
						alert("暂时获取不到位置信息。");
						break;
					case 3:
						alert("获取位置信息超时。");
						break;
					default:
						alert("未知错误。");
						break;
				}
				if (errorFunc != undefined)
					errorFunc(error);
				}, { timeout: 5000, enableHighAccuracy: true });
		} else {
			alert("你的浏览器不支持获取地理位置信息。");
			if (errorFunc != undefined)
				errorFunc("你的浏览器不支持获取地理位置信息。");
		}
	}
	
	$(function(){
		getLocation(function(addComp){
			console.log(arguments);
			$('#addr').val(addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber);
		});
	}); 
	var images = [];
	function serializeDetail() {
		var data = {};
		var base_info = {};
		$('#flow').find('.for_base').each(function(i, element){
			var ele_packet = {};
			var tag = $(element).attr('name')||$(element).attr('id');
			ele_packet[tag] = $(element).val();
			$.extend(base_info, ele_packet);
		});
		data.base_info = base_info;
	
		var busi_param = [];
		$('#s11,#s12 :checked').each(function(index, element) {
			var busi_type = {};
			var busi_tag = $(this).attr('name');
			$('#flow').find('.for_busi').each(function(i, ele){
				var ele_packet = {};
				var tag = $(ele).attr('name')||$(ele).attr('id');
				ele_packet[tag] = $(ele).val();
				$.extend(busi_type, ele_packet);
			});
			busi_type[busi_tag] = $(this).val();
			busi_param.push(busi_type);
		});
		data.busi_param = busi_param;
		
		data.elec_info = images;

		return data;
	}
	weui.form.checkIfBlur('#flow', $$.rules);
	
	function loadDetail() {
		$('#flow').find('.weui-uploader__files').each(function(i, element) {
			$(element).html('');
		});

		var images = data.images;
		var itemTpl = '<li class="weui-uploader__file weui-uploader__file_status" data-id="{{id}}"><div class="weui-uploader__file-content"><i class="weui-loading" style="width: 30px;height: 30px;"></i></div></li>';
		$.each(images, function(index, item) {
			var file = $($.render(itemTpl, {
				id: index
			}));
			$('#' + item.ei_type).append(file).data('file', item);
			file.css({
				backgroundImage: 'url("' + item.file_url + '")'
			});
		});

		$('#flow').form('load', data.data);
	}
		
	function saveDetail() {
		var data = serializeDetail();
		var busi = {};
		var type;
		if(data.busi_param.length > 1) {
			for(var i=0; i<data.busi_param.length; i++) {
				type += data.busi_param[i].busi_type+',';
			}
			type = type.substr(1, type.length-1);
		}
		for(var i=0; i<data.busi_param.length; i++) {
			$.extend(busi, data.busi_param[i]);
		}
		busi.busi_type = type;
		data.busi_param = busi;
		$$.request('/action/bm/base-busi/save', data, {
			success: function(data) {
				if (data.errcode == 0) {
					weui.toast('操作成功');
				} else {
					weui.alert(data.errmsg, { title: '提示' });
				}
			},
			error: function() {}
		});
	}
		
	function onSubmit() {
		if (!weui.form.validate('#flow', $$.rules)) return;
		var param = serializeDetail();

		$$.request('/action/bm/base-busi/create', param, {
			success: function(data) {
				if (data.errcode == 0) {
					weui.toast('操作成功');
				} else {
					weui.alert(data.errmsg, { title: '提示' });
				}
			},
			error: function() {}
		});
	}
		
    var flow = weui.flow('#flow', {
        finishText: '确认提交',
        nextText: '保存并下一步',
        previousText: '上一步',
        onStepChanging: function(currentIndex, newIndex) {
            console.log(arguments);
			saveDetail();
        },
        onStepChanged: function(newIndex, currentIndex) {
            console.log(arguments);
        },
        onFinishing: function(currentIndex) {
            console.log(arguments);
        },
        onFinished: function(currentIndex) {
            console.log(arguments);
			onSubmit();
        }
    });
		
    $('#s10,#s11,#s12').on('change', function() {
        if ($(this).prop('checked')) {
            $(this).closest('.weui-cell').siblings().show();
        } else {
            $(this).closest('.weui-cell').siblings().hide().find('input').val("").change();
        }
    });
	
	$('#district').on('click', function() {
		$$.showPicker(this, districtData);
	});
		
	$(function(){
		$('input,select').on('change', function(){
			var ele_name = $(this).attr('name');
			var ele_text = ($(this).prop('tagName') == 'INPUT')?($(this).val()):($(this).find('option :selected').text());
			if(ele_name != undefined) {
				console.log(ele_name);
				$('#save_all').find('span[name='+ele_name+']').html(ele_text);
			}
		});
		
		$('#acq_inst_id,#acq_inst_id2').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索',
                valueField: 'acq_inst_id',
                textField: 'acq_inst_nm',
                url: '/action/bm/acq-inst/search'
            }).search();
        });

        $('#subbranch_name').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索开户支行',
                valueField: 'bank_branch_cd',
                textField: 'bank_branch_nm',
                url: '/action/bm/bank-branch/search'
            }).search();
        });
		
		$('#debit_card_fee').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索手续费',
                valueField: 'fee_cd',
                textField: 'fee_nm',
                url: '/action/bm/fee/search',
                queryParams: {
                    debit_flag: '1'
                }
            }).search();
        });

        $('#credit_card_fee').on('focus', function() {
            $$.showSelect2(this, {
                title: '搜索手续费',
                valueField: 'fee_cd',
                textField: 'fee_nm',
                url: '/action/bm/fee/search',
                queryParams: {
                    credit_flag: '1'
                }
            }).search();
        });
	})
	
	$('.weui-uploader').each(function(i, element) {
		Uploader(this);
	});
	
	function Uploader(target, options) {
		options = options || {};
		var url = options.url? $$.wrapUrl(options.url):$$.wrapUrl('/action/upload');
		var max_size = options.max_size || 10;
		var max = options.max || 1;
		options = $.extend({
			url: url,
			onBeforeSend: function(data, headers) {
				console.log(this, arguments);
				if(["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0){
					weui.alert('请上传图片');
					return false; // 阻止文件添加
				}
				if(this.size > max_size * 1024 * 1024){
					weui.alert('请上传不超过10M的图片');
					return false;
				}
				// return false; // 阻止文件上传
			},
			onSuccess: function (ret) {
		        console.log(this, ret);
				var elec_info_type = $(target).find('.weui-uploader__files').attr('id');
				images.push({status:'1', serverid:ret.serverid, elec_info_type: elec_info_type});
		    },
		    onError: function(err){
		        console.log(this, err);
		    }
		}, options);
		return weui.ajaxUploader(target, options);
	}
    </script>
</body>

</html>
