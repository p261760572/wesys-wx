<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>我的</title>
    <link rel="stylesheet" href="js/lib/weuijs/style/weuijs.min.css">
    <link rel="stylesheet" href="css/ui-base.css">
</head>

<body>
    <div class="weui-tab page page_show">
        <div class="weui-panel weui-panel_access">
            <!--div class="weui-panel_bd">
                <a href="javascript:;" class="weui-media-box weui-media-box_appmsg weui-cell_access" onclick="weui.page.show('#nickname-page')">
                    <div class="weui-media-box__hd">
                        <i class="icon-user"></i>
                    </div>
                    <div class="weui-media-box__bd">
                        <h4 class="weui-media-box__title" id="nickname"></h4>
                        <p class="weui-media-box__desc" id="mobile"></p>
                        <p class="weui-media-box__desc" id="inst_name"></p>
                    </div>
                    <div class="weui-cell__ft">
                    </div>
                </a>
            </div-->
            <a href="javascript:;" class="weui-panel__hd weui-cell_access" onclick="weui.page.show('#nickname-page')"><span>昵称：</span><span id="nickname">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></a>
            <div class="weui-panel__bd" style="background-color:darkorange">
                <div class="weui-media-box weui-media-box_text" >
                    <h6 class="weui-media-box__title" align="center" id="yesterday_income">暂无收益</h6>
                    <p class="weui-media-box__desc" align="center">昨日收益</p>
                    <br>
                    <h1 class="weui-media-box__title" align="center"><span>累计收益：￥</span><span id="cumulative_income">0.00</span></h1>
                </div>
            </div>
            <br>
            <div class="weui-grids">
                <a href="javascript:;" class="weui-grid">
                    <div class="weui-grid__icon">
                        <i class="icon-income-b"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>未结算收益</p>
                        <p style="color: #999;">￥<span id="unsettled_income">0.00</span></p>
                    </div>
                </a>
                <a href="my/balance.html" class="weui-grid">
                    <div class="weui-grid__icon">
                        <i class="icon-balance"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>余额</p>
                        <p style="color: #999;">￥<span id="available_balance">0.00</span></p>
                    </div>
                </a>
                <a href="javascript:;" class="weui-grid" id="withdraw_his">
                    <div class="weui-grid__icon">
                        <i class="icon-business"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>提现记录</p>
                        <p style="color: #999;">&nbsp;</p>
                    </div>
                </a>
            </div>
            <br>
            <div class="weui-grids">
               <a href="my/bank-card.html" class="weui-grid">
                    <div class="weui-grid__icon">
                        <i class="icon-bank-card"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>我的银行卡</p>
                        <!--p style="color: #999;">&nbsp;</p-->
                    </div>
                </a>
                <a href="my/merchant.html" class="weui-grid">
                    <div class="weui-grid__icon">
                        <i class="icon-wealth"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>我的客户</p>
                    </div>
                </a>
                
                <!--a href="my/friend.html" class="weui-grid">
                    <div class="weui-grid__icon">
                        <i class="icon-friend"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>我的好友</p>
                    </div>
                </a-->
                <a href="my/setting.html" class="weui-grid">
                    <div class="weui-grid__icon">
                        <i class="icon-setting"></i>
                    </div>
                    <div class="weui-grid__label">
                        <p>设置</p>
                    </div>
                </a>
            </div>
        </div>
        <div class="weui-tabbar">
            <a href="index.html" class="weui-tabbar__item">
                <i class="icon-home"></i>
                <p class="weui-tabbar__label">首页</p>
            </a>
            <a href="tab-workorder.html" class="weui-tabbar__item">
                <i class="icon-list"></i>
                <p class="weui-tabbar__label">工作台</p>
            </a>
            <a href="javascript:;" class="weui-tabbar__item">
                <i class="icon-my"></i>
                <p class="weui-tabbar__label">我</p>
            </a>
        </div>
    </div>
    <div class="page" id="nickname-page">
        <form id="nickname-form" method="post" action="/action/user/update-nickname">
            <div class="weui-cells">
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">昵称</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="nickname" placeholder="请输入昵称" required="required">
                    </div>
                </div>
            </div>
            <div class="weui-btn-area btn-area">
                <a href="javascript:" class="weui-btn weui-btn_default" onclick="weui.page.back()">返回</a>
                <a id="nickname-submit-btn" href="javascript:" class="weui-btn weui-btn_primary">保存</a>
            </div>
        </form>
    </div>
    <div class="page" id="withdraw-list">
		<div class="weui-search-bar hide">
            <!-- <a href="javascript:" class="search-bar__btn" onclick="weui.page.back()">返回</a> -->
            <form class="weui-search-bar__form" method="post" action="">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" name="search" placeholder="搜索">
                    <a href="javascript:" class="weui-icon-clear"></a>
                </div>
                <label class="weui-search-bar__label">
                    <i class="weui-icon-search"></i>
                    <span>搜索</span> </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn">取消</a>
        </div>
		<div class="weui-cells searchbar-result">
		</div>
    </div>
    <script type="text/javascript" src="js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="js/lib/zepto.min.js"></script>
    <script type="text/javascript" src="js/lib/weuijs/weuijs.min.js"></script>
    <script type="text/javascript" src="js/wx.js"></script>
    <script id="withdraw-his-templ" type="text/html">
        {{each rows as row i}}
        <br>
        <div class="weui-form-preview">
            <div class="weui-form-preview__hd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">{{row.summary}}</label>
                    <em class="weui-form-preview__value">¥{{row.amount}}</em>
                </div>
            </div>
            <div class="weui-form-preview__bd">
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">提现账号</label>
                    <span class="weui-form-preview__value">{{row.bank_acct_no}}</span>
                </div>
                <div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">户名</label>
                    <span class="weui-form-preview__value">{{row.bank_acct_nm}}</span>
                </div>
				<div class="weui-form-preview__item">
                    <label class="weui-form-preview__label">系统交易号</label>
                    <span class="weui-form-preview__value">{{row.trans_no}}</span>
                </div>
            </div>
        </div>
        {{/each}}
    </script>
    <script type="text/javascript">
    wxConfig({
        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'onMenuShareQZone'],
        ready: function() {
            share()
        }
    });

    function share() {
        if (curent_user) {
            wxOnMenuShare({
                title: '湖南银信诺信息技术有限公司-' + curent_user.data.mobile.replace(/(\d{3})\d+(\d{4})/, '$1****$2'),
                link: window.location.origin + '/p/m/register.html?referral_id=' + curent_user.data.userid
            });
        }
    }

    function logout() {
        $$.request('/action/user/logout', {}, {
            success: function(data) {
                if (data.errcode == 0) {
                    window.location.href = 'login.html';
                }
            }
        });
    }
		
	function onNicknameSubmit() {
        if (!weui.form.validate('#nickname-form', $$.rules)) return;
        var param = $('#nickname-form').serializeObject();

        $$.request('/action/user/update-nickname', param, {
            success: function(data) {
                if (data.errcode == 0) {
                    weui.toast('操作成功', function() {
                        $('#nickname').html(param.nickname);
                        weui.page.back();
                    });
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            },
            error: function() {}
        });
    }
	
	function searchWithdraw(param, success, error) {
		var queryParams = $.extend(query, param);
        $$.request('/action/bm/account/withdraw-history', queryParams, {
            success: function(data) {
                if (data.errcode == 0) {
                    success(data.rows);
                } else {
					
                }
            },
            error: function() {
                error();
            }
        });
    }
	
	var searchWithdrawList = weui.searchPage('#withdraw-list', {
		resultTpl: '#withdraw-his-templ',
		loader: searchWithdraw,
		onInput: function() {
			console.log(this, arguments);
		},
		onClickItem: function(row) {
			console.log(this, arguments);
		}
	});
		
    var curent_user;
    $(function() {
		$('#nickname-submit-btn').on('click', onNicknameSubmit);
        $$.request('/action/user/view', {}, {
            success: function(data) {
                if (data.errcode == 0) {
                    curent_user = data;
                    share();
                    for (var name in data.data) {
                        $('#' + name).html(data.data[name]);
                    }
                } else if (data.errcode == 5) {
                    window.location.href = $$.wrapUrl('/m/login.html');
                } else {
                    weui.alert(data.errmsg, {
                        title: '提示'
                    });
                }
            }
        });
		$$.request('/action/account/view', {}, {
            success: function(data) {
				$$.load({
					available_balance: parseFloat(data.data.available_balance || 0).toFixed(2),
					unsettled_income: parseFloat(data.data.unsettled_income || 0).toFixed(2),
				}); //unsettled_income,balance
			}
							
        });
		$('#withdraw_his').on('click', searchWithdrawList.search());
    });
    </script>
</body>

</html>
